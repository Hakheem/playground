name: Auto Daily Commit

on:
  schedule:
    - cron: '0 0 * * *'  
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Scheduled auto-commit'

permissions:
  contents: write # This permission is needed for the PAT to push changes

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # Use your Personal Access Token for authentication
        # This allows commits to be attributed to your GitHub user
        token: ${{ secrets.PAT_TOKEN }} 
        fetch-depth: 0
    
    - name: Check for today's commits
      id: check_today
      run: |
        # Get today's date
        TODAY=$(date +%Y-%m-%d)
        
        # Check if there's any commit from today
        if git log --since="$TODAY 00:00:00" --oneline | grep -q .; then
          echo "Commit already made today. Skipping auto-commit."
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "No commits today. Proceeding with auto-commit."
          echo "skip=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Update timestamp and add random thoughts
      if: steps.check_today.outputs.skip == 'false'
      run: |
        # Array of random thoughts
        thoughts=(
          "The early bird gets the worm, but the second mouse gets the cheese."
          "Programming is like writing a book, except if you miss a single comma on page 126, the whole thing makes no sense."
          "The best time to plant a tree was 20 years ago. The second best time is now."
          "In a world where you can be anything, be kind."
          "The only way to do great work is to love what you do."
          "Simplicity is the ultimate sophistication."
          "The future belongs to those who believe in the beauty of their dreams."
          "Every day may not be good, but there is something good in every day."
          "The mind is everything. What you think you become."
          "Life is what happens to you while you're busy making other plans."
          "The journey of a thousand miles begins with one step."
          "Be the change that you wish to see in the world."
          "It always seems impossible until it's done."
          "Don't watch the clock; do what it does. Keep going."
          "The only limit to our realization of tomorrow will be our doubts of today."
          "You miss 100% of the shots you don't take."
          "The purpose of our lives is to be happy."
          "Stay hungry, stay foolish."
          "Your time is limited, so don't waste it living someone else's life."
          "The greatest glory in living lies not in never falling, but in rising every time we fall."
        )
        
        # Select a random thought
        random_index=$((RANDOM % ${#thoughts[@]}))
        selected_thought="${thoughts[$random_index]}"
        
        # Get current date and time in various formats
        CURRENT_DATE=$(date '+%Y-%m-%d')
        CURRENT_TIME=$(date '+%H:%M:%S')
        CURRENT_DATETIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
        DAY_OF_WEEK=$(date '+%A')
        EPOCH_TIME=$(date +%s)
        
        # Update the timestamp file
        echo "# Auto-Commit Timestamp" > timestamp.md
        echo "" >> timestamp.md
        echo "## Latest Update" >> timestamp.md
        echo "- **Date:** $CURRENT_DATE" >> timestamp.md
        echo "- **Time:** $CURRENT_TIME (Nairobi: 3:00 AM)" >> timestamp.md
        echo "- **Day:** $DAY_OF_WEEK" >> timestamp.md
        echo "- **Epoch Time:** $EPOCH_TIME" >> timestamp.md
        echo "- **GitHub Run ID:** ${{ github.run_id }}" >> timestamp.md
        echo "- **Run Number:** ${{ github.run_number }}" >> timestamp.md
        echo "" >> timestamp.md
        echo "## Today's Random Thought" >> timestamp.md
        echo "> \"$selected_thought\"" >> timestamp.md
        echo "" >> timestamp.md
        echo "## Previous Updates" >> timestamp.md
        
        # Add previous entries if the file already exists
        if [ -f timestamp.md.old ]; then
          echo "" >> timestamp.md
          echo "### History" >> timestamp.md
          echo "" >> timestamp.md
          echo "| Date | Time | Thought |" >> timestamp.md
          echo "|------|------|---------|" >> timestamp.md
          # Add last 5 entries from old file
          tail -n 10 timestamp.md.old | grep -E "^\|" | head -n 5 >> timestamp.md
        fi
        
        # Save current file as old for next run
        if [ -f timestamp.md ]; then
          cp timestamp.md timestamp.md.old
        fi
        
        # Create a JSON version
        echo '{' > auto-commit-data.json
        echo '  "last_commit": {' >> auto-commit-data.json
        echo '    "date": "'$CURRENT_DATE'",' >> auto-commit-data.json
        echo '    "time": "'$CURRENT_TIME'",' >> auto-commit-data.json
        echo '    "datetime": "'$CURRENT_DATETIME'",' >> auto-commit-data.json
        echo '    "day_of_week": "'$DAY_OF_WEEK'",' >> auto-commit-data.json
        echo '    "epoch": '$EPOCH_TIME',' >> auto-commit-data.json
        echo '    "github_run_id": "'${{ github.run_id }}'",' >> auto-commit-data.json
        echo '    "github_run_number": '${{ github.run_number }} >> auto-commit-data.json
        echo '  },' >> auto-commit-data.json
        echo '  "thought": "'$selected_thought'",' >> auto-commit-data.json
        echo '  "commit_type": "auto",' >> auto-commit-data.json
        echo '  "timezone": "Africa/Nairobi"' >> auto-commit-data.json
        echo '}' >> auto-commit-data.json
        
        # Append to log file
        echo "$CURRENT_DATETIME | $DAY_OF_WEEK | \"$selected_thought\"" >> auto-commit-history.log
        
        echo "Timestamp and thought updated successfully!"
        echo "Selected thought: $selected_thought"
    
    - name: Configure Git
      if: steps.check_today.outputs.skip == 'false'
      run: |
        git config --local user.email "hectorjohn254@gmail.com" 
        git config --local user.name "Hakheem"        
        git config --local core.autocrlf false
    
    - name: Commit and push changes
      if: steps.check_today.outputs.skip == 'false'
      run: |
        # Add all changed files
        git add timestamp.md auto-commit-data.json auto-commit-history.log timestamp.md.old 2>/dev/null || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit. Creating empty commit to maintain schedule."
          git commit --allow-empty -m "chore: auto-commit $(date '+%Y-%m-%d') - No changes detected"
        else
          git commit -m "chore: auto-commit $(date '+%Y-%m-%d %H:%M:%S')
          
          - Updated timestamp files
          - Added daily random thought
          - Nairobi time: 3:00 AM
          - Run ID: ${{ github.run_id }}"
        fi
        
        # Push changes
        git push origin HEAD:${{ github.ref_name }}
        
        echo "âœ… Auto-commit completed successfully"
